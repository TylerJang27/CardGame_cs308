# Bug Report 11

## Description

An exception's stack trace is printed upon reporting an error to the frontend. 

## Expected Behavior

No exceptions should be printed to the console. All exceptions regarding the proper flow of user input, IMove processing, and updates to Cells should be
hidden to the user with the exception of popups generated by the frontend.

## Current Behavior

Whenever any reportable error is produced (e.g. missing/invalid style file, missing/invalid score file, or missing/invalid rules/layout file for a game),
in addition to the proper popup being displayed, a stack trace is printed to the console.

## Steps to Reproduce

Provide detailed steps for reproducing the issue.

 1. Freshly pull the program from master.
 2. Delete the ```data/default_style.xml``` file if it exists (this file is created locally based on user changes to 
 ```data/default_style_orig.xml```).
 3. Launch the program and observe the stack trace.

## Failure Logs

```
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	at javafx.graphics/com.sun.javafx.application.LauncherImpl.lambda$launchApplication1$9(LauncherImpl.java:846)
	at javafx.graphics/com.sun.javafx.application.PlatformImpl.lambda$runAndWait$12(PlatformImpl.java:455)
	at javafx.graphics/com.sun.javafx.application.PlatformImpl.lambda$runLater$10(PlatformImpl.java:428)
	at java.base/java.security.AccessController.doPrivileged(AccessController.java:391)
	at javafx.graphics/com.sun.javafx.application.PlatformImpl.lambda$runLater$11(PlatformImpl.java:427)
	at javafx.graphics/com.sun.glass.ui.InvokeLaterDispatcher$Future.run(InvokeLaterDispatcher.java:96)
	at javafx.graphics/com.sun.glass.ui.win.WinApplication._runLoop(Native Method)
	at javafx.graphics/com.sun.glass.ui.win.WinApplication.lambda$runLoop$3(WinApplication.java:174)
	at java.base/java.lang.Thread.run(Thread.java:830)
```

## Hypothesis for Fixing the Bug

This bug occurs as a result of the ```reportError()``` method in Controller. An ```e.printStackTrace()``` line was left in the original code
in master, causing the stack trace to be printed even when the error is displayed correctly to the frontend.

More testing will be needed to determine all the cases in which this method is called based on different invalid cases.

Once all of these cases are identified, the line can be removed and the tests can be run again to ensure that no stack trace is printed.

## Additional Analysis on Related Methods

The following are a number of methods that may require testing to fully diagnose this bug and its reach:

- ```processMove()```, process a move from the frontend but sending to backend and update the View
	- ```getAndUpdateScoreForGame()```
	- update the View using the backend updates

- ```getAndUpdateScoreForGame()```, update the table based on a move
	- process an IMove based on the phase machine
	- update high scores

- ```updateHighScores()```, sets the scores and updates the frontend's HighScore information based on the current game
	- *the ```setScore()``` method call may need to be surrounded by try catch if the IHighScore implementation does not have the correct file path*
	- the view's high scores are updated

- ```extractScores()```, read from a file containing high score information and create an IStyle implementation
	- tests for HighScoreFactory have already been generated

- ```extractStyle()```, read from a file containing style information and create an IStyle implementation
	- tests for StyleFactory have already been generated

- ```loadGame()```, load a game from a XML save data
	- an ISaveConfiguration instance is loaded
	- an ISaveConfiguration instance is applied

- ```startTable()```, starts a new table based on a game name
	- *redundancies can be refactored*
	- starts a new table based on a game name
	- loads rules based on PhaseMachineFactory
	
## Initial Tests and Results (test/ooga/controller/ControllerTest.java)

I made the above tests protected in order to have access to them for testing.
Based on [assorted counsel](https://softwareengineering.stackexchange.com/questions/100959/how-do-you-unit-test-private-methods),
I believed that this was a good compromise with minimal consequences as Controller has no children and its
package contains no other classes.

### start()

Result when file has already been created:
```PASS```

Result when file has not been created: 
```java
PASS 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	...
```

### processMove()

Result when file has already been created:
```java
java.lang.NullPointerException
	at ooga.data.rules.PhaseMachine.replaceMoveCells(PhaseMachine.java:154)
	at ooga.data.rules.PhaseMachine.update(PhaseMachine.java:204)
	at ooga.cardtable.Table.update(Table.java:55)
	at ooga.controller.Controller.getAndUpdateScoreForGame(Controller.java:157)
	at ooga.controller.Controller.processMove(Controller.java:116)
	at ooga.controller.ControllerTest.lambda$processMove$1(ControllerTest.java:121)
	...

org.opentest4j.AssertionFailedError: Unexpected exception type thrown ==> expected: <java.lang.IllegalStateException> but was: <java.lang.NullPointerException>

	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:65)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.processMove(ControllerTest.java:121)
	...
Caused by: java.lang.NullPointerException
	at ooga.controller.Controller.reportError(Controller.java:215)
	at ooga.controller.Controller.getAndUpdateScoreForGame(Controller.java:169)
	at ooga.controller.Controller.processMove(Controller.java:116)
	at ooga.controller.ControllerTest.lambda$processMove$1(ControllerTest.java:121)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:55)
	...
```

Result when file has not been created:
```java
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:68)
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:42)
	at ooga.controller.Controller.extractScores(Controller.java:189)
	at ooga.controller.Controller.start(Controller.java:95)
	...
java.lang.NullPointerException
	at ooga.data.rules.PhaseMachine.replaceMoveCells(PhaseMachine.java:154)
	at ooga.data.rules.PhaseMachine.update(PhaseMachine.java:204)
	at ooga.cardtable.Table.update(Table.java:55)
	at ooga.controller.Controller.getAndUpdateScoreForGame(Controller.java:157)
	at ooga.controller.Controller.processMove(Controller.java:116)
	at ooga.controller.ControllerTest.lambda$processMove$1(ControllerTest.java:121)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:55)
	...

org.opentest4j.AssertionFailedError: Unexpected exception type thrown ==> expected: <java.lang.IllegalStateException> but was: <java.lang.NullPointerException>

	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:65)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.processMove(ControllerTest.java:121)
	...
Caused by: java.lang.NullPointerException
	at ooga.controller.Controller.reportError(Controller.java:215)
	at ooga.controller.Controller.getAndUpdateScoreForGame(Controller.java:169)
	at ooga.controller.Controller.processMove(Controller.java:116)
	...
```

### getAndUpdateScoreForGame()

Result when file has already been created:

```java
PASS 1/1
```

Result when file has not been created:

```java
PASS 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:68)
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:42)
	at ooga.controller.Controller.extractScores(Controller.java:189)
	at ooga.controller.Controller.start(Controller.java:95)
	...
```

### extractStyle()

Result when file has already been created:

```java
PASS 1/1
```

Result when file has not been created:

```java
PASS 1/1
```

### extractScores()

Result when file has already been created:

```java
PASS 1/1
```

Result when file has not been created:

```java
PASS 1/1
```

### updateHighScores()

Result when file has already been created:

```java
PASS 1/1
```

Result when file has not been created:

```java
PASS 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:68)
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:42)
	at ooga.controller.Controller.extractScores(Controller.java:189)
	at ooga.controller.Controller.start(Controller.java:95)
	....
```

### reportError()

Result when file has already been created:

```java
FAIL 1/1
org.opentest4j.AssertionFailedError: Unexpected exception type thrown ==> expected: <java.lang.IllegalStateException> but was: <java.util.MissingResourceException>

	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:65)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.reportError(ControllerTest.java:232)
	...
Caused by: java.util.MissingResourceException: Can't find resource for bundle java.util.PropertyResourceBundle, key bad error message
	at java.base/java.util.ResourceBundle.getObject(ResourceBundle.java:564)
	at java.base/java.util.ResourceBundle.getString(ResourceBundle.java:521)
	at ooga.view.View.translateAndFormat(View.java:202)
	at ooga.view.View.reportError(View.java:273)
	at ooga.controller.Controller.reportError(Controller.java:221)
	at ooga.controller.ControllerTest.lambda$reportError$7(ControllerTest.java:232)
	...
```

Result when file has not been created:

```java
FAIL 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:68)
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:42)
	at ooga.controller.Controller.extractScores(Controller.java:189)
	...


org.opentest4j.AssertionFailedError: Unexpected exception type thrown ==> expected: <java.lang.IllegalStateException> but was: <java.util.MissingResourceException>

	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:65)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.reportError(ControllerTest.java:232)
	...
Caused by: java.util.MissingResourceException: Can't find resource for bundle java.util.PropertyResourceBundle, key bad error message
	at java.base/java.util.ResourceBundle.getObject(ResourceBundle.java:564)
	at java.base/java.util.ResourceBundle.getString(ResourceBundle.java:521)
	at ooga.view.View.translateAndFormat(View.java:202)
	at ooga.view.View.reportError(View.java:273)
	at ooga.controller.Controller.reportError(Controller.java:221)
	at ooga.controller.ControllerTest.lambda$reportError$7(ControllerTest.java:232)
	...
```

### loadGame()

Result when file has already been created:

```java
PASS
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.SaveConfigurationFactory.createSave(SaveConfigurationFactory.java:66)
	at ooga.controller.Controller.loadGame(Controller.java:233)
	at ooga.controller.ControllerTest.lambda$loadGame$8(ControllerTest.java:248)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:55)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.loadGame(ControllerTest.java:248)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.SaveConfigurationFactory.createSave(SaveConfigurationFactory.java:66)
	at ooga.controller.Controller.loadGame(Controller.java:233)
	at ooga.controller.ControllerTest.lambda$loadGame$10(ControllerTest.java:250)
	...
```

Result when file has not been created:

```java
PASS 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:68)
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:42)
	at ooga.controller.Controller.extractScores(Controller.java:189)
	at ooga.controller.Controller.start(Controller.java:95)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.SaveConfigurationFactory.createSave(SaveConfigurationFactory.java:66)
	at ooga.controller.Controller.loadGame(Controller.java:233)
	at ooga.controller.ControllerTest.lambda$loadGame$8(ControllerTest.java:248)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.SaveConfigurationFactory.createSave(SaveConfigurationFactory.java:66)
	at ooga.controller.Controller.loadGame(Controller.java:233)
	at ooga.controller.ControllerTest.lambda$loadGame$10(ControllerTest.java:250)
	...
```

### startTable()

Result when file has already been created:

```java
PASS 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.PhaseMachineFactory.createPhaseMachine(PhaseMachineFactory.java:64)
	at ooga.controller.Controller.startTable(Controller.java:266)
	at ooga.controller.ControllerTest.lambda$startTable$12(ControllerTest.java:268)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:55)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.startTable(ControllerTest.java:268)
```

Result when file has not been created:

```java
PASS 1/1
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:77)
	at ooga.data.factories.StyleFactory.createStyle(StyleFactory.java:52)
	at ooga.controller.Controller.extractStyle(Controller.java:178)
	at ooga.controller.Controller.start(Controller.java:94)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:68)
	at ooga.data.factories.HighScoreFactory.createScores(HighScoreFactory.java:42)
	at ooga.controller.Controller.extractScores(Controller.java:189)
	at ooga.controller.Controller.start(Controller.java:95)
	...
ooga.data.XMLException: InvalidFile
	at ooga.data.factories.PhaseMachineFactory.createPhaseMachine(PhaseMachineFactory.java:64)
	at ooga.controller.Controller.startTable(Controller.java:266)
	at ooga.controller.ControllerTest.lambda$startTable$12(ControllerTest.java:268)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:55)
	at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:37)
	at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:2920)
	at ooga.controller.ControllerTest.startTable(ControllerTest.java:268)
	...
```

## Changes to Resolve the Bug

1. the e.printStackTrace() in reportError() of Controller was removed.
2. attachView() was reordered in Controller (see notes in ControllerTest.processMove()).
3. added an additional default case and try-catch in reportError() of Controller if the message does not adhere to the expected format.

## Final Tests and Results

### start()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### processMove()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### getAndUpdateScoreForGame()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### extractStyle()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### extractScores()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### updateHighScores()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### reportError()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### loadGame()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

### startTable()

Result when file has already been created:
```java
PASS 1/1
```

Result when file has not been created:
```java
PASS 1/1
```

